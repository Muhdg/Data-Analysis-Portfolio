-- LOOKING AT ALL THE DATA
SELECT *
FROM CovidDeaths

-- SELECTING FIELDS TO WORK WITH (CONTINENT IS NOT NULL BECAUSE WHEN CONTINENT IS NOT, THE CONTINENT APPEARS IN LOCATION)
SELECT 
	location,
	date,
	population,
	total_cases,
	total_deaths
FROM CovidDeaths
WHERE continent IS NOT NULL

--1 TOTAL CASES PER LOCATION
SELECT 
	LOCATION,
	SUM(TOTAL_CASES)
FROM CovidDeaths
GROUP BY location
ORDER BY 2 DESC

--2 CASES PER MONTH
SELECT
	location,
	DATETRUNC(MONTH, date) MONTH,
	SUM(TOTAL_CASES) PER_MONTH
FROM CovidDeaths
WHERE continent IS NOT NULL
GROUP BY LOCATION, DATETRUNC(MONTH, DATE)
ORDER BY 1

--3 TOTALDEATHS PER CASE
SELECT 
	location,
	SUM(total_cases) cases,
	SUM(cast(total_deaths as int)) deaths,
	(SUM(cast(total_deaths as int))/SUM(total_cases)) * 100 per_case
FROM CovidDeaths
WHERE continent IS NOT NULL
GROUP BY location
ORDER BY 4 DESC

--4 MONTHS WITH THE HIGHEST CASES
WITH T1 AS 
(SELECT
	location,
	DATETRUNC(MONTH, date) MONTH,
	SUM(TOTAL_CASES) CASES,
	RANK() OVER (PARTITION BY LOCATION ORDER BY SUM(TOTAL_CASES) DESC) RANK
FROM CovidDeaths
WHERE continent IS NOT NULL
GROUP BY LOCATION, DATETRUNC(MONTH, DATE)
)

SELECT
	LOCATION,
	MONTH,
	CASES
FROM T1
WHERE RANK = 1 AND CASES IS NOT NULL

--5 AVERAGE CASE AND DEATH PER DAY
WITH T1 AS
(SELECT
	LOCATION,
	DATETRUNC(DAY, date) DAY,
	SUM(TOTAL_CASES) CASES,
	SUM(CAST(TOTAL_DEATHS AS float)) DEATHS
FROM CovidDeaths
WHERE continent IS NOT NULL
GROUP BY location, DATETRUNC(DAY, date))

SELECT 
	LOCATION,
	AVG(CASES),
	AVG(DEATHS)
FROM T1
GROUP BY location

--6 AVERAGE CASE PER MONTH
WITH T1 AS
(SELECT
	location,
	DATETRUNC(MONTH, date) MONTH,
	SUM(TOTAL_CASES) PER_MONTH
FROM CovidDeaths
WHERE continent IS NOT NULL
GROUP BY LOCATION, DATETRUNC(MONTH, DATE))

SELECT 
	LOCATION,
	AVG(PER_MONTH) AVERAGE
FROM T1
GROUP BY location
HAVING AVG(PER_MONTH) IS NOT NULL

